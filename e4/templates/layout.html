<!doctype html>
<title>E4</title>

<link rel=stylesheet type=text/css href="{{ url_for('static', filename='style.css') }}" />
<style type=text/css>

.currencies  { /*display: Timeinline-block; */ width: 40%; float: right; 
                  list-style-type: none; padding: 0; font-family: monospace; 
                  margin: 0; padding-right: 3em; background-color:  #FFFFFF; font-size: 75%; text-align: right; }
.currencies li  { display: inline; padding-left: 0.3em; padding-right: 0.3em; }



.balance li, .accounts li { list-style-type: none; margin: 0; padding: 0; }
#income  { display: none; }
table.entries { 
  font-size:66%;
  width:100%;
  display: inline-block;
  vertical-align: text-top;
}
.money {text-align: right;}
#balance dl, #balance input { margin-left: 1em; font-size: 75%; }
#balance, #accounts {
  display: none;
  border-width: 2px;
  border-style: solid;
  border-color: green;
  width: 20%;  
  background-color:  #FFFFFF;
  margin-left: 3em;
}
#balance dd {
  font-family: monospace;
  text-align: right;
  margin-right: .5em;
}
</style>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="//code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="//code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<script src="{{ url_for('static', filename='up.js') }}"></script>
<!-- Latest compiled and minified CSS - >
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous" />
< ! -- Optional theme - >
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous" />
< ! -- Latest compiled and minified JavaScript  - >
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous" /></script>
< ! -- -->
<script>
//$( document ).ready(function() { c_update('/api/currency') ; get_balance() });
var balance_url;
var d = new Date();
balance_url = '/api/balance/0/' + getFirstWeek(d) + '/' + addMonths(getFirstWeek(d), 6 );

function reload_all() {
  load_table('backlogs_table', '/api/backlog');
  load_table('incomes_table', '/api/income');
  load_table('transactions_table', '/api/transaction');
  load_table('accounts_table', '/api/account');
  get_balance(balance_url);
 }

$( document ).ready( function() {
  var balance_url;
  reload_all();
  update_option('.account_selector', '/api/account',['title', 'currency']);
  update_option('.period_selector', '/api/intervals');
  update_option('.currency_selector', '/api/currency');
  c_update('/api/currency');
  $('#balance input').change(function(event){
    var a = {'start_date':'', 'end_date':''};
    a[$(this).attr('name')] = $(this).val();
    a[$(this).siblings('input').attr('name')] = $(this).siblings('input').val();
    balance_url = '/api/balance/0/'+a['start_date']+'/'+a['end_date'];
    get_balance(balance_url);
  });
  get_balance(balance_url);
 });

function load_table(table_name, url){
  $('#' + table_name + ' tr').not('.template').not('.table_header').remove();
  var template = $('#'+table_name).find('tr.template');
  var new_row, n;
  $.getJSON(url, function(data){
    $.each(data, function(k, v){
      if (v['deleted']=='y') {return false;}
      new_row = template.clone(true).removeClass('template');
      new_row.find('.row_update').each(function(){
        $(this).text(json_names($(this).attr('name'), v));
      });
      template.after(new_row);
      new_row.show();
    });
  });
 }

function prepare_transfer(event) {
  var source_account = $(event.target).parents('form').find('[name="account.id"]').val();
  var already_set = false;
  var parent_form =  $(event.target).parents('form');
  parent_form.find('.transfer').show().addClass('form_save').prop('disabled', true);
  $('#transfer-dialog').find('[name="account.name"]').val(source_account).prop('disabled', true);
  $('#transfer-dialog').find('[name="transfer.account"]').val((source_account + 1) % $('#transfer-dialog').find('[name="transfer.account"]').children('option').length);
  $('#transfer-dialog').find('[name="transfer.account"]').children('option').each(function(){
    if (! already_set &&  $(this).val() != source_account) {
      $(this).parent().val($(this).val());
      already_set=true;
    }
    $(this).prop('disabled', $(this).val() == source_account)
  });

  $('#transfer-dialog').dialog({
    buttons: [
      {
        text: 'Ok',
        click: function(){
          parent_form.find('[name="new_account.id"]').val($(this).dialog().find('[name="transfer.account"]').val());
          parent_form.find('[name="new_sum"]').val($(this).dialog().find('[name="transfer.sum"]').val());
          $(this).dialog( "close" );
        }
      }
    ]
  }).focus();
 }

function get_balance(url){
  $.getJSON('/api/currency', function(data){
    var c = [];
    $.each(data, function(c_index, currency){
      c.push('<dt>'+ currency['title'] +'</dt>')
    });
    c.push('<dt>TOTAL</dt>');
    c.push('<dt>weeks</dt>');
    c.push('<dt>weekly</dt>');
    $('#balance dl.balance').html(c.join(''));
    $.getJSON(url, function(data){
      $.each(data, function(key, val){
        $('#balance dt').each(function(){
          if ($(this).text() == key) {
            $(this).after('<dd>'+val+'</dd>');
          }
        });
        if (['start_date', 'end_date'].indexOf(key) > -1){
          $('#balance input.'+key).val(val);
        };
      });
      $.getJSON('/api/account', function(data){
        var c = []
        $.each(data, function(k, v){
          if (v['show'] == 'y'  ) { 
            c.push('<dt>'+v['title']+ ' ' + v['currency']['title'] +'</dt><dd>'+ v['sum'] +'</dd>');
          }
        });        
        $('#balance dl.accounts').html(c.join(''));
      });
    });
  });
  

  
  $('#balance').show();  
 }


function get_accounts(url, title_fields=['title', 'currency.title']) {
  $.getJSON(url, function(data){
    var options = [];
    $.each(data, function(key, val){
      titles = []
      title_fields.forEach( function(t){ titles.push( (t=='title') ? val[t] : val[t]['title'])});
      options.push('<li>'+ titles.join(' ') +'</li>')
    });
    $('#accounts').html(options.join('')).show();
  })
 }


function update_row(event, to_update, clean=false){
  var id = $(event.target).parents('tr').find("[name=id]").text();
  var row = $(event.target).parents('tr');
  var template = $(event.target).parents('table').find('tr.template');
  // var first_row = $(event.target).parents('tr').siblings().first();
  var buttons=[];
  if (clean) {
    $('form#'+to_update)[0].reset();
    $('#'+to_update).find('input.set_today.datepicker').datepicker('setDate', new Date());
   };
  var transfer_id = 0;
  row.find('.row_update').each(function(){
    var n , v;
    n = $(this).attr('name');
    v = $(this).text().trim();
    $('#' + to_update).find("[name='" + n + "']" ).each(function(){
      $(this).val( v )
     });
    if (n == 'transfer' && v > 0) {
      transfer_id = v;
    }
   });
  
  // check transfer

  console.log(transfer_id);
  if ( transfer_id > 0) {
    console.log('do transfer');
    var j = $.getJSON('/api/transaction/'+transfer_id, function(data){
      $('#'+to_update).find('[name=new_sum]').val(data['sum']).prop('disabled', true).show();
      $('#'+to_update).find('[name="new_account.id"]').val(data['account']['id']).prop('disabled', true).show();
      $('#'+to_update).find('.transfer-button').hide();
      console.log(data);
    });
    $('#'+to_update).find('.transfer-button').show();
  } else {

  }
  
  if (! clean) {
    buttons = [
      {text: 'Delete', click: function(){
        var data={};
        $(this).dialog().find(".form_save").each(function(f, k){
          data[k.name] = k.value.replace(/^\s+|\s+$/g,'');
        });
        $.ajax({
          type: "DELETE",
          url: "/api/" + to_update + "/" + id,
          headers: { 
              'Accept': 'application/json',
              'Content-Type': 'application/json' 
            },
          dataType: 'json',
          //data: "id=" + id,
          data: JSON.stringify(data),
          success: function(msg){
            row.remove();
            get_balance(balance_url);
            reload_all();
            
           }
        });
        $(this).dialog( "close" );
      }},
      {text: 'Ok', click: function(){
          var data_={};
          $(this).dialog().find(".form_save").each(function(f, k){
            data_[k.name] = k.value.replace(/^\s+|\s+$/g,'');
          });
          $.ajax({
            type: "PUT",
            headers: { 
              'Accept': 'application/json',
              'Content-Type': 'application/json' 
            },
            dataType: 'json',
            url: "/api/" + to_update + "/" + id,
            data: JSON.stringify(data_),
            success: function(data){
              updated=data['updated'];
              row.find('.row_update').each(function(){
                $(this).text(json_names($(this).attr('name'), updated))
              });
              
              get_balance(balance_url);
              reload_all();
              
            }
          });
          $(this).dialog( "close" );
      }}
     ]

   } else {
    buttons = [
      {text: 'Insert', click: function(){
      var data={};
      $(this).dialog().find(".form_save").each(function(f, k){
        data[k.name] = k.value.replace(/^\s+|\s+$/g,'');
      });
      $.ajax({
        type: "POST",
        headers: { 
          'Accept': 'application/json',
          'Content-Type': 'application/json' 
        },
        dataType: 'json',
        url: "/api/" + to_update ,
        data: JSON.stringify(data),
        success: function(data){
          var new_row=template.clone(true).removeClass('template');
          new_row.find('.row_update').each(function(){
            $(this).text(json_names($(this).attr('name'), data))
          });
          template.after(new_row);
          new_row.show();
          get_balance(balance_url);
          reload_all();
        }
      });
      $(this).dialog( "close" );

     }}
     ]
   }
  
  $('#' + to_update).find('.transfer').hide().addClass('hidden').removeClass('form_save');
  $('#' + to_update).find('.transfer-button').show();
  $('#' + to_update).dialog({ buttons: buttons }).focus(); 

 }


$( function() {
    $( ".datepicker" ).datepicker({ dateFormat: $.datepicker.W3C, changeYear: true });

 });

</script>
{% block js %}
{% endblock %}
<body>


<!--
<div class=accounts>    
<ul id="accounts"></ul>
</div>
-->

<div class=page>
  <h1>E4</h1>
    {% if session.logged_in %}
  <div>
    <ul id="currencies" class="currencies"></ul>
    </div>
    {% endif %}

  <div class=metanav>
    {% if not session.logged_in %}
      <a href="{{ url_for('login') }}">log in</a>
    {% else %}
      <a href="{{ url_for('logout') }}">log out</a>
    {% endif %}
    </div>
  {% for message in get_flashed_messages() %}
  <div class=flash>{{ message }}</div>
  {% endfor %}
   
  {% block body %}{% endblock %}
</div>
</body>
